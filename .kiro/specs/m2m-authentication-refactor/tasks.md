# 実装計画

- [ ] 1. 環境設定とM2M認証インフラの準備
- [x] 1.1 M2M認証設定の環境変数処理を実装
  - AGENTCORE_PROVIDER_NAME環境変数の読み込み処理を追加
  - M2M認証パラメータの設定クラスを作成
  - 環境変数が未設定の場合のエラーハンドリングを実装
  - _要件: 1.2, 3.1, 3.2_

- [ ]* 1.2 環境設定のプロパティテストを作成
  - **プロパティ 3: 環境設定**
  - **検証対象: 要件 1.2, 3.1, 3.2, 3.3**

- [ ] 2. @requires_access_tokenデコレータの実装
- [x] 2.1 get_mcp_client_from_gateway関数を@requires_access_tokenデコレータ付きで作成
  - 適切なデコレータパラメータ（provider_name, scopes, auth_flow, force_authentication）を設定
  - access_tokenパラメータを受け取る関数シグネチャを実装
  - MCPクライアント作成ロジックを実装
  - _要件: 1.1, 1.3, 1.4, 1.5, 2.1_

- [ ]* 2.2 M2M認証デコレータのプロパティテストを作成
  - **プロパティ 1: M2M認証デコレータ使用**
  - **検証対象: 要件 1.1, 1.3, 1.4, 1.5, 2.1**

- [x] 2.3 MCPゲートウェイ通信をアクセストークン使用に更新
  - _call_mcp_gateway関数をaccess_tokenパラメータ使用に変更
  - Bearerトークン認証ヘッダーを実装
  - JWTトークン依存を削除
  - _要件: 2.2, 2.3, 2.4_

- [ ]* 2.4 アクセストークン統合のプロパティテストを作成
  - **プロパティ 2: アクセストークン統合**
  - **検証対象: 要件 2.2, 2.3, 2.4**

- [ ] 3. メモリID検証の厳格化
- [x] 3.1 BEDROCK_AGENTCORE_MEMORY_ID環境変数の厳格な検証を実装
  - 環境変数が未設定の場合の即座エラーを実装
  - フォールバックAPI呼び出しを削除
  - 明確なエラーメッセージを追加
  - _要件: 4.1, 4.2, 4.3_

- [ ]* 3.2 メモリID検証のプロパティテストを作成
  - **プロパティ 4: メモリID検証**
  - **検証対象: 要件 4.1, 4.2, 4.3**

- [ ] 3.3 AgentCore Memory設定ロジックの更新
  - BEDROCK_AGENTCORE_MEMORY_IDを直接使用する設定に変更
  - メモリ設定失敗時のエラーハンドリングを改善
  - _要件: 4.4, 4.5_

- [ ] 4. JWT処理とM2M認証の適切な分離
- [x] 4.1 JWT処理ロジックの保持（ユーザー識別専用）
  - JWTトークンからのsub抽出機能を完全に保持（Actor ID用）
  - ペイロード処理でのJWTトークン抽出を保持（HealthmateUIから渡される）
  - JWT処理関数を保持（_decode_jwt_payload、_get_sub_from_jwt、_get_jwt_token）
  - JWTトークンはユーザー識別のみに使用、MCP Gateway認証には使用しない
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ]* 4.2 JWT処理保持のプロパティテストを作成
  - **プロパティ 5: JWT処理保持**
  - **検証対象: 要件 5.1, 5.2, 5.3, 5.4**

- [x] 4.3 M2M認証とJWT処理の明確な分離
  - M2M認証: Agent → Gateway呼び出しの認証専用
  - JWT処理: HealthmateUI → Agent のユーザー識別専用
  - 両者は独立して動作し、相互にフォールバックしない
  - MCPゲートウェイ呼び出しではM2M認証のみ使用
  - _要件: 5.5_

- [ ] 5. デプロイメントスクリプトの更新
- [x] 5.1 deploy_to_aws.shスクリプトにM2M設定を追加
  - AGENTCORE_PROVIDER_NAME環境変数設定を追加
  - 既存環境変数（HEALTHMANAGER_GATEWAY_ID、AWS_REGION）を維持
  - CloudFormation出力の検証ロジックを追加
  - BEDROCK_AGENTCORE_MEMORY_ID環境変数の検証を追加
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ]* 5.2 デプロイメントスクリプトの単体テストを作成
  - 環境変数設定のテスト
  - CloudFormation出力検証のテスト
  - _要件: 3.4, 3.5_

- [ ] 6. エラーハンドリングの強化
- [x] 6.1 M2M認証エラーハンドリングを実装
  - 認証失敗時の明確なエラーメッセージを実装
  - MCPクライアント作成失敗のエラーハンドリングを追加
  - 認証とMCP通信エラーのログ記録を実装
  - HTTP ステータスコード別の詳細なエラーハンドリングを追加
  - タイムアウトと接続エラーの専用処理を実装
  - _要件: 2.5, 4.5, 6.5_

- [ ]* 6.2 エラーハンドリングのプロパティテストを作成
  - **プロパティ 7: エラーハンドリング**
  - **検証対象: 要件 2.5, 4.5, 6.5**

- [ ] 7. AgentCore Identity統合の設定
- [x] 7.1 AgentCore Identity統合を設定
  - HealthManagerのWorkload Identity設定との連携を確認
  - OAuth2 Credential Provider統合を設定
  - Client CredentialsフローによるM2M認証を実装
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ]* 7.2 AgentCore Identity統合のプロパティテストを作成
  - **プロパティ 6: AgentCore Identity統合**
  - **検証対象: 要件 6.1, 6.2, 6.3, 6.4**

- [ ] 8. エージェントエントリーポイントの更新
- [ ] 8.1 invoke関数をM2M認証対応に変更
  - M2M認証に対応したペイロード処理を実装
  - JWTトークン検証をエントリーポイントから削除
  - M2M互換のセッションとactor ID処理を実装
  - _要件: 5.5_

- [ ]* 8.2 エージェントエントリーポイントの統合テストを作成
  - M2M認証でのエージェント呼び出しテスト
  - JWT依存なしのペイロード処理テスト
  - _要件: 5.5_

- [x] 9. 中間チェックポイント
  - 全テストが通過することを確認し、問題があればユーザーに質問する

- [ ] 10. 設定ファイルとドキュメントの更新
- [ ] 10.1 エージェント設定ファイルの更新
  - .bedrock_agentcore.yamlファイルをM2M認証対応に更新
  - 設定ドキュメントを更新
  - _要件: 3.5_

- [ ]* 10.2 設定検証の単体テストを作成
  - 設定ファイル解析のテスト
  - 環境変数検証のテスト
  - _要件: 3.5_

- [ ] 11. 統合テストとエンドツーエンドテスト
- [ ] 11.1 完全なM2M認証フローの統合テスト
  - HealthManager MCPとのエンドツーエンドM2M認証をテスト
  - AgentCore IdentityとOAuth2 Credential Provider統合を検証
  - M2MトークンでのMCPゲートウェイ通信をテスト
  - _要件: 全要件_

- [ ]* 11.2 包括的統合テストを作成
  - 完全な認証とMCP通信フローのテスト
  - エラーシナリオと復旧のテスト
  - _要件: 全要件_

- [ ] 12. 最終チェックポイント
  - 全テストが通過することを確認し、問題があればユーザーに質問する