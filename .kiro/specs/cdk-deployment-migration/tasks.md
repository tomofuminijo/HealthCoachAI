# 実装計画

- [x] 0. Python仮想環境の準備
  - 既存の .venv 仮想環境をアクティベート
  - CDK開発に必要な依存関係のインストール
  - 開発環境の確認
  - _要件: 1.1_

- [x] 0.1 仮想環境をアクティベート
  - `source .venv/bin/activate` で既存の仮想環境をアクティベート
  - Python バージョンと pip の確認
  - _要件: 1.1_

- [x] 0.2 CDK依存関係をインストール
  - `pip install aws-cdk-lib constructs` でCDK関連パッケージをインストール
  - `pip install boto3 pyyaml` で追加の必要パッケージをインストール
  - _要件: 1.1_

- [x] 0.3 開発環境を確認
  - `cdk --version` でCDKインストールを確認
  - AWS認証情報の確認
  - _要件: 1.1_

- [x] 1. CDKプロジェクト基盤の構築
  - CDKプロジェクト構造の作成とPython環境の設定
  - 必要な依存関係の追加とCDK初期化
  - _要件: 1.1, 1.2_

- [x] 1.1 CDKプロジェクト構造を作成
  - cdk/ ディレクトリ構造の作成
  - app.py、cdk.json、requirements.txt の作成
  - CDK Python環境の初期化
  - _要件: 1.1_

- [ ]* 1.2 プロパティテスト: CDKリソース定義の完全性
  - **プロパティ 1: CDKリソース定義の完全性**
  - **検証対象: 要件 1.1**

- [x] 1.3 基本的なCDKスタッククラスを実装
  - CoachAICDKStack クラスの作成
  - 基本的なスタック設定とコンストラクタの実装
  - _要件: 1.1, 1.2_

- [ ]* 1.4 プロパティテスト: 統合リソース作成
  - **プロパティ 2: 統合リソース作成**
  - **検証対象: 要件 1.2, 3.4**

- [x] 2. IAMロールとポリシーの実装
  - AgentCore Runtime用のIAMロールとポリシーの定義
  - 既存のカスタムロールと同等の権限設定
  - _要件: 3.3_

- [x] 2.1 IAMロールリソースを作成
  - bedrock-agentcore.amazonaws.com 用の信頼ポリシー設定
  - 実行ロールの作成と基本設定
  - _要件: 3.3_

- [x] 2.2 IAMポリシーを定義
  - Bedrock、AgentCore、CloudWatch Logs、ECR権限の設定
  - CloudFormation読み取り権限の追加
  - _要件: 3.3_

- [ ]* 2.3 プロパティテスト: IAM権限同等性
  - **プロパティ 12: IAM権限同等性**
  - **検証対象: 要件 3.3**

- [x] 3. CfnAgentリソースの実装
  - AWS BedrockAgentCore CfnAgent の設定
  - エージェント設定とデプロイメント設定の実装
  - _要件: 1.2, 3.1, 3.2_

- [x] 3.1 CfnAgentリソースを定義
  - agent_name、entrypoint、platform設定
  - deployment_type、runtime_type設定
  - _要件: 3.1, 3.2_

- [x] 3.2 エージェント設定を実装
  - AWS設定（execution_role、region、account）
  - ネットワーク設定とプロトコル設定
  - _要件: 3.1, 3.2_

- [ ]* 3.3 プロパティテスト: デプロイメント同等性
  - **プロパティ 10: デプロイメント同等性**
  - **検証対象: 要件 3.1**

- [ ]* 3.4 プロパティテスト: エージェント設定継続性
  - **プロパティ 11: エージェント設定継続性**
  - **検証対象: 要件 3.2**

- [x] 4. ECRリポジトリとCodeBuildの実装
  - ECRリポジトリの作成と管理設定
  - CodeBuildプロジェクトの設定
  - _要件: 1.2, 3.4_

- [x] 4.1 ECRリポジトリを作成
  - リポジトリ名とライフサイクルルールの設定
  - イメージスキャン設定
  - _要件: 3.4_

- [x] 4.2 CodeBuildプロジェクトを設定
  - ビルド環境とソース設定
  - IAMロールとビルドスペックの設定
  - _要件: 1.2_

- [x] 5. クロススタック統合の実装
  - HealthManagerスタックからの情報取得
  - Gateway統合設定の自動化
  - _要件: 2.1, 2.3_

- [x] 5.1 クロススタック参照を実装
  - Fn.import_value を使用したGateway ID取得
  - Cognito設定の取得
  - _要件: 2.1_

- [ ]* 5.2 プロパティテスト: クロススタック情報取得
  - **プロパティ 5: クロススタック情報取得**
  - **検証対象: 要件 2.1**

- [x] 5.3 環境変数設定を実装
  - HEALTHMANAGER_GATEWAY_ID、AWS_REGION等の設定
  - 動的な環境変数の管理
  - _要件: 2.3, 3.5_

- [ ]* 5.4 プロパティテスト: 統合設定自動化
  - **プロパティ 7: 統合設定自動化**
  - **検証対象: 要件 2.3, 3.5**

- [x] 6. メモリとログ設定の実装
  - AgentCore Memory設定
  - CloudWatchログ統合
  - _要件: 6.3_

- [x] 6.1 メモリ設定を実装
  - STM_ONLY モードの設定
  - イベント有効期限の設定
  - _要件: 6.3_

- [x] 6.2 CloudWatchログ統合を実装
  - ロググループとログストリームの設定
  - ログ保持期間の設定
  - _要件: 6.3_

- [ ]* 6.3 プロパティテスト: CloudWatch統合
  - **プロパティ 23: CloudWatch統合**
  - **検証対象: 要件 6.3**

- [x] 7. スタック出力の実装
  - 作成されたリソース情報の出力
  - 他のサービスとの統合用情報の提供
  - _要件: 1.5_

- [x] 7.1 スタック出力を定義
  - Agent ARN、Agent ID、ECR Repository URI等の出力
  - 統合用の設定情報出力
  - _要件: 1.5_

- [ ]* 7.2 プロパティテスト: スタック出力提供
  - **プロパティ 4: スタック出力提供**
  - **検証対象: 要件 1.5**

- [x] 8. チェックポイント - 基本CDK機能の検証
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる

- [ ] 9. 移行ヘルパーの実装
  - 既存.bedrock_agentcore.yaml設定の読み取り
  - 設定変換とマッピング機能
  - _要件: 7.1_

- [ ] 9.1 設定ファイル読み取り機能を実装
  - YAML パーサーの実装
  - 既存設定の検証機能
  - _要件: 7.1_

- [ ] 9.2 設定変換機能を実装
  - agentcore設定からCDK設定への変換
  - 設定マッピングテーブルの作成
  - _要件: 7.1_

- [ ]* 9.3 プロパティテスト: 設定変換
  - **プロパティ 26: 設定変換**
  - **検証対象: 要件 7.1**

- [ ] 10. 既存リソース処理の実装
  - 既存リソースの検出機能
  - インポート・置き換えオプションの提供
  - _要件: 7.2_

- [ ] 10.1 既存リソース検出を実装
  - AWS APIを使用したリソース検出
  - リソース状態の確認機能
  - _要件: 7.2_

- [ ] 10.2 リソース処理オプションを実装
  - インポートオプションの実装
  - 置き換えオプションの実装
  - _要件: 7.2_

- [ ]* 10.3 プロパティテスト: 既存リソース処理
  - **プロパティ 27: 既存リソース処理**
  - **検証対象: 要件 7.2**

- [ ] 11. バックアップ・復旧機能の実装
  - 移行前のバックアップ作成
  - ロールバック機能の実装
  - _要件: 7.3, 7.5_

- [ ] 11.1 バックアップ機能を実装
  - 現在のデプロイメント状態の保存
  - 設定ファイルのバックアップ
  - _要件: 7.3_

- [ ]* 11.2 プロパティテスト: 移行バックアップ
  - **プロパティ 28: 移行バックアップ**
  - **検証対象: 要件 7.3**

- [ ] 11.3 ロールバック機能を実装
  - 以前の設定への復帰機能
  - 復旧手順の自動化
  - _要件: 7.5_

- [ ]* 11.4 プロパティテスト: ロールバック方法提供
  - **プロパティ 30: ロールバック方法提供**
  - **検証対象: 要件 7.5**

- [ ] 12. エラーハンドリングの実装
  - CDKデプロイメントエラーの処理
  - 詳細なエラー情報の提供
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 12.1 デプロイメントエラーハンドリングを実装
  - 自動ロールバック機能
  - エラー分類と対応策の実装
  - _要件: 4.1, 4.2_

- [ ]* 12.2 プロパティテスト: 自動ロールバック実行
  - **プロパティ 13: 自動ロールバック実行**
  - **検証対象: 要件 4.1**

- [ ]* 12.3 プロパティテスト: 統合エラー情報提供
  - **プロパティ 14: 統合エラー情報提供**
  - **検証対象: 要件 4.2, 4.3**

- [ ] 12.4 権限・依存関係エラーハンドリングを実装
  - 権限不足の検出と明示
  - 依存関係問題の診断
  - _要件: 4.3, 4.4_

- [ ]* 12.5 プロパティテスト: 権限不足明示
  - **プロパティ 15: 権限不足明示**
  - **検証対象: 要件 4.4**

- [ ] 12.6 クリーンアップ機能を実装
  - 部分的失敗時のリソースクリーンアップ
  - 失敗状態からの回復機能
  - _要件: 4.5_

- [ ]* 12.7 プロパティテスト: 失敗時クリーンアップ
  - **プロパティ 16: 失敗時クリーンアップ**
  - **検証対象: 要件 4.5**

- [ ] 13. 環境設定管理の実装
  - 環境変数とコンテキスト値による設定調整
  - リージョン・スタック名のカスタマイズ
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 13.1 環境設定システムを実装
  - コンテキスト値による設定調整
  - 環境変数の優先順位管理
  - _要件: 5.1_

- [ ]* 13.2 プロパティテスト: 統合環境設定管理
  - **プロパティ 17: 統合環境設定管理**
  - **検証対象: 要件 5.1, 5.2**

- [ ] 13.3 カスタマイズ機能を実装
  - カスタムスタック名の処理
  - 依存関係の動的解決
  - _要件: 5.3, 5.4_

- [ ]* 13.4 プロパティテスト: カスタムスタック名使用
  - **プロパティ 18: カスタムスタック名使用**
  - **検証対象: 要件 5.3**

- [ ]* 13.5 プロパティテスト: 依存関係解決
  - **プロパティ 19: 依存関係解決**
  - **検証対象: 要件 5.4**

- [ ] 14. デバッグ・監視機能の実装
  - デバッグモードでの詳細ログ出力
  - メトリクス収集とヘルスチェック
  - _要件: 5.5, 6.4, 6.5_

- [ ] 14.1 デバッグログ機能を実装
  - 詳細ログ出力の設定
  - デバッグ情報の構造化
  - _要件: 5.5_

- [ ]* 14.2 プロパティテスト: デバッグログ出力
  - **プロパティ 20: デバッグログ出力**
  - **検証対象: 要件 5.5**

- [ ] 14.3 メトリクス・ヘルスチェック機能を実装
  - CloudWatchメトリクス設定
  - 自動ヘルスチェック機能
  - _要件: 6.4, 6.5_

- [ ]* 14.4 プロパティテスト: メトリクス出力
  - **プロパティ 24: メトリクス出力**
  - **検証対象: 要件 6.4**

- [ ]* 14.5 プロパティテスト: 自動ヘルスチェック
  - **プロパティ 25: 自動ヘルスチェック**
  - **検証対象: 要件 6.5**

- [ ] 15. テスト互換性の実装
  - 既存テストスクリプトとの互換性確保
  - ステータス情報の同等性実装
  - _要件: 6.1, 6.2_

- [ ] 15.1 テストスクリプト互換性を実装
  - 既存テストスクリプトの動作確認
  - 必要な環境変数・設定の提供
  - _要件: 6.1_

- [ ]* 15.2 プロパティテスト: テストスクリプト互換性
  - **プロパティ 21: テストスクリプト互換性**
  - **検証対象: 要件 6.1**

- [ ] 15.3 ステータス情報機能を実装
  - agentcore status相当の情報提供
  - エージェント状態の監視機能
  - _要件: 6.2_

- [ ]* 15.4 プロパティテスト: ステータス情報同等性
  - **プロパティ 22: ステータス情報同等性**
  - **検証対象: 要件 6.2**

- [ ] 16. 動的設定更新の実装
  - 外部依存関係変更への対応
  - MCP接続の継続性確保
  - _要件: 2.2, 2.4, 2.5_

- [ ] 16.1 動的設定更新機能を実装
  - 外部依存関係の監視
  - 設定の自動更新機能
  - _要件: 2.4_

- [ ]* 16.2 プロパティテスト: 動的設定更新
  - **プロパティ 8: 動的設定更新**
  - **検証対象: 要件 2.4**

- [ ] 16.3 MCP接続機能を実装
  - 適切な環境変数でのMCP接続
  - MCPプロトコルの継続性確保
  - _要件: 2.2, 2.5_

- [ ]* 16.4 プロパティテスト: MCP接続確立
  - **プロパティ 6: MCP接続確立**
  - **検証対象: 要件 2.2**

- [ ]* 16.5 プロパティテスト: MCPプロトコル継続性
  - **プロパティ 9: MCPプロトコル継続性**
  - **検証対象: 要件 2.5**

- [ ] 17. 競合回避・移行完了機能の実装
  - 既存リソースとの競合回避
  - 移行完了時の推奨事項提供
  - _要件: 1.4, 7.4_

- [ ] 17.1 競合回避機能を実装
  - 既存リソースとの名前衝突検出
  - 代替名の自動生成
  - _要件: 1.4_

- [ ]* 17.2 プロパティテスト: 既存リソース競合回避
  - **プロパティ 3: 既存リソース競合回避**
  - **検証対象: 要件 1.4**

- [ ] 17.3 移行完了機能を実装
  - 古い設定の無効化推奨
  - 移行完了レポートの生成
  - _要件: 7.4_

- [ ]* 17.4 プロパティテスト: 移行完了推奨
  - **プロパティ 29: 移行完了推奨**
  - **検証対象: 要件 7.4**

- [ ] 18. デプロイメントスクリプトの作成
  - CDKデプロイ用のスクリプト作成
  - 移行用のヘルパースクリプト作成
  - _要件: 1.2, 7.1_

- [ ] 18.1 CDKデプロイスクリプトを作成
  - deploy_cdk.sh スクリプトの作成
  - 環境設定とデプロイオプションの実装
  - _要件: 1.2_

- [ ] 18.2 移行スクリプトを作成
  - migrate_to_cdk.py スクリプトの作成
  - 段階的移行プロセスの実装
  - _要件: 7.1_

- [ ] 19. ドキュメントとREADMEの更新
  - CDKデプロイメント手順の文書化
  - 移行ガイドの作成
  - _要件: 7.4_

- [ ] 19.1 CDKデプロイメント文書を作成
  - README.md の更新
  - デプロイメント手順の詳細化
  - _要件: 7.4_

- [ ] 19.2 移行ガイドを作成
  - 段階的移行手順の文書化
  - トラブルシューティングガイドの作成
  - _要件: 7.4_

- [ ] 20. 最終チェックポイント - 全機能の統合テスト
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる